name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: asia-northeast3
  GCP_ZONE: asia-northeast3-a
  ARTIFACT_REGISTRY: asia-northeast3-docker.pkg.dev
  REPOSITORY_NAME: connectable
  SERVICE_NAME: connectable-api

jobs:
  # ============================================================================
  # Build & Test Job
  # ============================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build with Gradle
        run: ./gradlew clean build -x test --no-daemon

      - name: Run tests
        run: ./gradlew test --no-daemon
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build/libs/*.jar
            build/reports/tests/
          retention-days: 7

  # ============================================================================
  # Docker Build & Push Job
  # ============================================================================
  docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Build JAR
        run: ./gradlew clean bootJar -x test --no-daemon

      - name: Extract metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          BRANCH_NAME=${{ github.ref_name }}
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          if [ "$BRANCH_NAME" = "main" ]; then
            VERSION="latest"
          else
            VERSION="dev-${TIMESTAMP}-${SHORT_SHA}"
          fi
          
          IMAGE_TAG="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.SERVICE_NAME }}:${VERSION}"
          echo "tags=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Image tag: $IMAGE_TAG"

      - name: Build Docker image
        run: |
          docker build \
            --build-arg JAR_FILE=build/libs/*.jar \
            -t ${{ steps.meta.outputs.tags }} \
            -f Dockerfile \
            .

      - name: Push Docker image
        id: build
        run: |
          docker push ${{ steps.meta.outputs.tags }}
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ steps.meta.outputs.tags }} | cut -d'@' -f2)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Deploy to Compute Engine
        if: github.ref_name == 'main'
        run: |
          gcloud compute ssh ${{ env.SERVICE_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --command="sudo systemctl restart connectable-api && sleep 5 && sudo systemctl status connectable-api" \
            || {
              echo "=== Deploy failed. Fetching logs ==="
              gcloud compute ssh ${{ env.SERVICE_NAME }} \
                --zone=${{ env.GCP_ZONE }} \
                --command="sudo journalctl -u connectable-api --no-pager -n 50"
              exit 1
            }
