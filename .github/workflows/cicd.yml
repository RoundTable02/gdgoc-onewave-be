name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: asia-northeast3
  GCP_ZONE: asia-northeast3-a
  ARTIFACT_REGISTRY: asia-northeast3-docker.pkg.dev
  REPOSITORY_NAME: connectable
  SERVICE_NAME: connectable-api

jobs:
  # ============================================================================
  # Build & Test Job
  # ============================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build with Gradle
        run: ./gradlew clean build -x test --no-daemon

      - name: Run tests
        run: ./gradlew test --no-daemon
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build/libs/*.jar
            build/reports/tests/
          retention-days: 7

  # ============================================================================
  # Docker Build & Push Job
  # ============================================================================
  docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Extract metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          BRANCH_NAME=${{ github.ref_name }}
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          if [ "$BRANCH_NAME" = "main" ]; then
            VERSION="latest"
          else
            VERSION="dev-${TIMESTAMP}-${SHORT_SHA}"
          fi
          
          IMAGE_TAG="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.SERVICE_NAME }}:${VERSION}"
          echo "tags=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Image tag: $IMAGE_TAG"

      - name: Build Docker image
        run: |
          docker build \
            --build-arg JAR_FILE=build/libs/*.jar \
            -t ${{ steps.meta.outputs.tags }} \
            -f Dockerfile \
            .

      - name: Push Docker image
        id: build
        run: |
          docker push ${{ steps.meta.outputs.tags }}
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ steps.meta.outputs.tags }} | cut -d'@' -f2)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

  # ============================================================================
  # Terraform Plan Job (PR only)
  # ============================================================================
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      id-token: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"
          terraform_wrapper: false

      - name: Terraform Format Check
        id: fmt
        working-directory: ./terraform
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Validate
        id: validate
        working-directory: ./terraform
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        working-directory: ./terraform
        run: |
          terraform plan -no-color -input=false \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="container_image=dummy-image-for-plan" \
            -var="worker_image=${{ secrets.WORKER_IMAGE || 'dummy-worker' }}" \
            -var="supabase_host=${{ secrets.SUPABASE_HOST }}" \
            -var="supabase_password=${{ secrets.SUPABASE_PASSWORD }}" \
            -var="gemini_api_key=${{ secrets.GEMINI_API_KEY }}" \
            -var="gcs_bucket_name=${{ secrets.GCS_BUCKET_NAME }}" \
            -var="supabase_db=${{ secrets.SUPABASE_DB }}" \
            -var="supabase_user=${{ secrets.SUPABASE_USER }}"
        continue-on-error: true

      - name: Update PR with Plan Results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            <details><summary>Validation Output</summary>

            \`\`\`\n
            ${{ steps.validate.outputs.stdout }}

            \`\`\`

            </details>

            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`\n
            ${process.env.PLAN}

            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Working Directory: \`terraform\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # ============================================================================
  # Terraform Apply & Deploy Job (Main branch only)
  # ============================================================================
  deploy:
    name: Deploy to GCP
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write

    environment:
      name: production
      url: ${{ steps.deploy.outputs.api_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Apply
        id: deploy
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve -input=false \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="container_image=${{ needs.docker.outputs.image_tag }}" \
            -var="worker_image=${{ secrets.WORKER_IMAGE }}" \
            -var="supabase_host=${{ secrets.SUPABASE_HOST }}" \
            -var="supabase_password=${{ secrets.SUPABASE_PASSWORD }}" \
            -var="gemini_api_key=${{ secrets.GEMINI_API_KEY }}" \
            -var="gcs_bucket_name=${{ secrets.GCS_BUCKET_NAME }}" \
            -var="supabase_db=${{ secrets.SUPABASE_DB }}" \
            -var="supabase_user=${{ secrets.SUPABASE_USER }}"

          # Capture outputs
          API_URL=$(terraform output -raw api_url)
          VM_IP=$(terraform output -raw vm_external_ip)
          WORKER_URL=$(terraform output -raw worker_url)
          
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "vm_ip=$VM_IP" >> $GITHUB_OUTPUT
          echo "worker_url=$WORKER_URL" >> $GITHUB_OUTPUT

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30

      - name: Health Check
        run: |
          API_URL="${{ steps.deploy.outputs.api_url }}"
          echo "Checking health at: $API_URL/actuator/health"
          
          for i in {1..10}; do
            if curl -sf "$API_URL/actuator/health" > /dev/null 2>&1 || \
               curl -sf "$API_URL/health" > /dev/null 2>&1 || \
               curl -sf "$API_URL/api/health" > /dev/null 2>&1; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i/10: Service not ready yet, waiting..."
            sleep 15
          done
          
          echo "Health check failed after 10 attempts"
          exit 1
        continue-on-error: true

      - name: Deployment Summary
        run: |
          echo "========================================"
          echo "üöÄ Deployment Complete!"
          echo "========================================"
          echo "API URL: ${{ steps.deploy.outputs.api_url }}"
          echo "VM IP: ${{ steps.deploy.outputs.vm_ip }}"
          echo "Worker URL: ${{ steps.deploy.outputs.worker_url }}"
          echo "Image: ${{ needs.docker.outputs.image_tag }}"
          echo "========================================"
